{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "virtualMachineName": {
      "type": "string",
      "defaultValue": "ca-lab-vm"
    },
    "registryMachineName": {
      "type": "string",
      "defaultValue": "registry"
    },
    "productionMachineName": {
      "type": "string",
      "defaultValue": "production"
    },
    "virtualMachineSize": {
      "type": "string",
      "defaultValue": "Basic_A1"
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "student"
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "ca-lab-vnet"
    },
    "networkInterfaceName": {
      "type": "string",
      "defaultValue": "ca-lab-vm001"
    },
    "registryInterfaceName": {
      "type": "string",
      "defaultValue": "registry001"
    },
    "productionInterfaceName": {
      "type": "string",
      "defaultValue": "production001"
    },
    "networkSecurityGroupName": {
      "type": "string",
      "defaultValue": "ca-lab-vm-nsg"
    },
    "adminPassword": {
      "type": "string",
      "defaultValue": "1Cloud_Academy_Labs!"
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "calabdisks01"
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS"
    },
    "addressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24"
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "default"
    },
    "subnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24"
    },
    "publicIpAddressName": {
      "type": "string",
      "defaultValue": "ca-lab-vm-ip"
    },
    "publicIpAddressType": {
      "type": "string",
      "defaultValue": "Dynamic"
    },
    "registryPublicIpAddressName": {
      "type": "string",
      "defaultValue": "registry-ip"
    },
    "productionPublicIpAddressName": {
      "type": "string",
      "defaultValue": "production-ip"
    }
  },
  "resources": [
    {
      "name": "[parameters('virtualMachineName')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2016-04-30-preview",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', parameters('networkInterfaceName'))]",
        "[concat('Microsoft.Storage/storageAccounts/', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', ''))]"
      ],
      "properties": {
        "osProfile": {
          "computerName": "[parameters('virtualMachineName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachineSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "7.3",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "fromImage",
            "vhd": {
              "uri": "[concat(concat(reference(resourceId('Microsoft.Storage/storageAccounts', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', '')), '2015-06-15').primaryEndpoints['blob'], 'vhds/'), parameters('virtualMachineName'), '20170526205708.vhd')]"
            },
            "name": "[parameters('virtualMachineName')]"
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
            }
          ]
        }
      }
    },
    {
      "name": "[parameters('registryMachineName')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2016-04-30-preview",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', parameters('registryInterfaceName'))]",
        "[concat('Microsoft.Storage/storageAccounts/', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', ''))]"
      ],
      "properties": {
        "osProfile": {
          "computerName": "[parameters('registryMachineName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachineSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "7.3",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "fromImage",
            "vhd": {
              "uri": "[concat(concat(reference(resourceId('Microsoft.Storage/storageAccounts', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', '')), '2015-06-15').primaryEndpoints['blob'], 'vhds/'), parameters('registryMachineName'), '20170526205708.vhd')]"
            },
            "name": "[parameters('registryMachineName')]"
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('registryInterfaceName'))]"
            }
          ]
        }
      }
    },
    {
      "name": "[parameters('productionMachineName')]",
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2016-04-30-preview",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', parameters('productionInterfaceName'))]",
        "[concat('Microsoft.Storage/storageAccounts/', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', ''))]"
      ],
      "properties": {
        "osProfile": {
          "computerName": "[parameters('productionMachineName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachineSize')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "OpenLogic",
            "offer": "CentOS",
            "sku": "7.3",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "fromImage",
            "vhd": {
              "uri": "[concat(concat(reference(resourceId('Microsoft.Storage/storageAccounts', replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', '')), '2015-06-15').primaryEndpoints['blob'], 'vhds/'), parameters('productionMachineName'), '20170526205708.vhd')]"
            },
            "name": "[parameters('productionMachineName')]"
          },
          "dataDisks": []
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('productionInterfaceName'))]"
            }
          ]
        }
      }
    },
    {
      "name": "microsoft.docker-lab-vm",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.docker-arm.1.1.0/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('virtualMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "dockerPort": {
            "value": "2376"
          },
          "dockerCACert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFlTCCA32gAwIBAgIJAJGWHcDSvIgiMA0GCSqGSIb3DQEBCwUAMGAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEUMBIGA1UEAwwLY2EtbGFicy5jb20wIBcNMTcw\nNzA1MDcyNzUyWhgPMjExNzA2MTEwNzI3NTJaMGAxCzAJBgNVBAYTAlVTMQswCQYD\nVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQGA1UECgwNQ2xvdWQg\nQWNhZGVteTEUMBIGA1UEAwwLY2EtbGFicy5jb20wggIiMA0GCSqGSIb3DQEBAQUA\nA4ICDwAwggIKAoICAQC86tv/HZ0Kj6d7r7JeHBWN+PloX8dmXA5s7elD5kx89K3w\n9AlC+l9NR5jsFuoUKNWjPy/QCcvZrSxpDOlfhGdemOfVPMUxfz8StBRsmIulIzYw\nEGaBk0CqxFSDd93raNZb+fOE6+M6xVYzlVjtVTDhcR4i0MOWrF8vMnp1aZ8esRl5\nVOGpEWo8N/t6c7nwEEfX3nS+HOuPMoV6dEKPHx0RHQCbosMuVZl9cruoUuXFTHb+\nKPzcXwwbEIIVADfqLs2u2ML5UH2GG/k7whpoussEqfJOp6621frp6ZHOkeOeuL+j\n740coMXxTph3lH6iuQHn7E0h/d22b6EROvJa2SnVpIdPKRAxNXQuMeH3JMfgx2nP\n8Vfesosc4lAz5/Ds2Egwl9kbUvTpnSVNdbriwgBdRgd1hVh2hFOOcx+5DbD63Gru\nPEqDmswzlGP3PkIBUj0RWlRleSJRZncjj7zzK26ng5heY8ZunRKnfbZ2kNDu12/B\nBJfcZH0chHW7yrld6+5EbXKMGhODisXvzvei5JJFgzHYxodyO4UvRq16nlKW6T9f\nc3uilaT/x6wnEx8puHmJMj+PAft0FaMO/1VjPoLTOkV3Yaz4A6tcwhdAVBlMJfEz\nYuHimBmOH5BnmcD0QxBuj8axnUjmL7Fit55mfZb6GmJthBnS93ZHy50BtDFO2wID\nAQABo1AwTjAdBgNVHQ4EFgQU97Wl7NWSWFn8TjzYccy/OpsuVp4wHwYDVR0jBBgw\nFoAU97Wl7NWSWFn8TjzYccy/OpsuVp4wDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0B\nAQsFAAOCAgEAtpp+yw0e5LwAFP3S/KsV7DFwZlePvt/ynYm3hjCEZKcqR13/gwBf\npSJrSe3V9X1F87iI2/0WcVl8Ut0euv3uBI1+dVR/gvyqYtQ+8vF2F8ZwCKfEcL8D\n/7aJqjJm/Otoss9xMokU3XwE3lmhVUFRxYAP/WDqSEtDeqGJbLyFR5vCk64/TU3j\ncJ3/jXDkPF07B1ttX+lfyDxW3+29AaW5O08VjnYxSAKMXbwVowkRlzM9DmXVeJ5L\nKn3Z2iOYCNe4vha55dyv2xef1cC8VeJM3JIGY/nwJKgigXG2YwSPCYLjqNKFpXDM\n4dnaDRID2Z3V1VPPXA8DlhLc+AO+kaIp9cHH9uhoJ2Eag4XtMaIVyS3RQ1vQ0Da7\nVs++N8C15JPPuTFcLw46z3ILMd8nPZ1/BWTzYFsi4Jx6b7FGm7IBktqGFRQEaAyZ\nkYhKMVYnzF2lkHhkOUYSlveGd+zllYfugwXp7Gj7RKutq4ImixIfHq3MP4JK2AWh\nbmp3PL6+HVZn2ZkWxuWsFVunVxA+AM4BHXJ8FXhpnV+xjQEPZgf4g51ZRcQNE+A5\nKaJ7vCtAXrxNCp1UlWEKB/jxg6vUtIBB6twYjs5YE5QPy5SYGueTC41Plvt8eAtW\nqtpgRuIUatEvvMX2L2dbdE0OfK/67oVGXj0dOz17XomNH7fSEeStugg=\n-----END CERTIFICATE-----\n"
          },
          "dockerServerCert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFDTCCAvWgAwIBAgIJANtnQZQgh0RpMA0GCSqGSIb3DQEBCwUAMGAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEUMBIGA1UEAwwLY2EtbGFicy5jb20wIBcNMTcw\nNzA1MDczMDEyWhgPMjExNzA2MTEwNzMwMTJaMBExDzANBgNVBAMMBmNsaWVudDCC\nAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAMqEaEBmA1qGPDMc95TjrCut\nlyCtw3+i33pqfmDdDQ9zpSnOWEIdqVcLyzCZoex5nZO+I0dHJA8XqDZ7UiEoDd8h\nwUeS/MCKCj2WKjMZkNxSXPR8PQAkOnNsOIAzS9f2inuPDEJIqd1HuZ82dnKpNgL2\ntmZlrn33D40YLK+KpZUBZco1SpgIqsBRY3TwG1MolHToVVrbFFPFg7jDaas4mTkP\nP+L701ujkspntIsCbxhimA5t5D/3mzUEQJLbSrgpIWFPRyWkSdVN6/vm1FD/6GAV\nb0cJQJH5f+iT5F9XXNCnnt0MFhkLFqBRG9Mb6+LVt1OHskheMcd2ddd+atjHze02\n9n8ZUcpzZQ7E0o+FxJ8fktBItc48sBz24TywRMrBHFP3ZVQJ6P60WGaSd/F+ZU8/\nCmZwTz+NyDUW/0SarIg6IjTp0ZLQ7d98srhgWHPihEj3aDZ1rsJG5/tI0KTk0HqZ\noPbQgA7ZDJCRdJiOfanYplwAzB4iiu4/cjgtDbLLv7B9FC+gLEJDd/tP78ux8qyO\nL0X+Lw+E630q7ocRNDFB9AcmyFtD5Bxo240HE4dMfAG762gS9KpfNkcge0Jf5LBx\nkWPKhvDEKqyqvKWPPVZTZ7I1Z28XfQ2XBvC9aX2Ow6UkZDDIE9AyvgV3NruFp7Lk\n1mXg4j/+5V8IE/FOQxNFAgMBAAGjFzAVMBMGA1UdJQQMMAoGCCsGAQUFBwMCMA0G\nCSqGSIb3DQEBCwUAA4ICAQCpiQMZj8u8KMwseqBeDrEHosc12ovWLseF9Xe5H2JC\neBGD8ZtiTZXpDHOO0Qrw4R7e0DQtajRSe7KoMnwx3XHxRqa0DeBH4avHKQzIcai5\n6kY90lLCOwamfLQKg9//4r8/9Lshq59hZiHsNPS9QgGcucHpfdOE0mz/NKgJHpl7\n92dQYbsQPuUqrylrm5nDVS1tIFbm+Ig9zsE/Mn2hwJqy+nK5RrNX+hzT/3rbxtLL\nZb5+UH0FPLQT2vrygW0Pdos9QXA51SFExmUis64RQ7metXlVtQ2lRAPuF45QZzXX\nMwXByZJ+hUZWiMzv7dfFaFsq/kMbToUgp0WG7B64AQd2DedhK4Stx/G4mZ9s+VO/\nZ6DsNNupUbDLsqB1OcufmKHE4CAmxM+x57wI5Xz1Ed3g1ugMeX7wrvGZoxEr3V19\niv7jNED3QJMdMNr6MsCOGZA31QrUXIOlVV1L4tV5kMmMpkO1qeRsiqQqlh8leOIa\n433k9TSJGLGUR9MD3mPfqagwRMDHb0B19tgEoI63xSm1BhBKOn+PFmHBqfaonNli\niGy5GSXOtUbUd92iK/+ufBXiEOtBosrmb7nIZ5gi1oWQNjHFx7nV1ICD7a89NJ1n\nXC/WcjW6avn416mUuC/AzKWwLjFJhyGFjbNUIagGnYJPdCKrqYRsXLSWmhCVxF3c\niw==\n-----END CERTIFICATE-----\n"
          },
          "dockerServerKey": {
            "value": "-----BEGIN RSA PRIVATE KEY-----\nMIIJKQIBAAKCAgEAyoRoQGYDWoY8Mxz3lOOsK62XIK3Df6Lfemp+YN0ND3OlKc5Y\nQh2pVwvLMJmh7Hmdk74jR0ckDxeoNntSISgN3yHBR5L8wIoKPZYqMxmQ3FJc9Hw9\nACQ6c2w4gDNL1/aKe48MQkip3Ue5nzZ2cqk2Ava2ZmWuffcPjRgsr4qllQFlyjVK\nmAiqwFFjdPAbUyiUdOhVWtsUU8WDuMNpqziZOQ8/4vvTW6OSyme0iwJvGGKYDm3k\nP/ebNQRAkttKuCkhYU9HJaRJ1U3r++bUUP/oYBVvRwlAkfl/6JPkX1dc0Kee3QwW\nGQsWoFEb0xvr4tW3U4eySF4xx3Z1135q2MfN7Tb2fxlRynNlDsTSj4XEnx+S0Ei1\nzjywHPbhPLBEysEcU/dlVAno/rRYZpJ38X5lTz8KZnBPP43INRb/RJqsiDoiNOnR\nktDt33yyuGBYc+KESPdoNnWuwkbn+0jQpOTQepmg9tCADtkMkJF0mI59qdimXADM\nHiKK7j9yOC0Nssu/sH0UL6AsQkN3+0/vy7HyrI4vRf4vD4TrfSruhxE0MUH0BybI\nW0PkHGjbjQcTh0x8AbvraBL0ql82RyB7Ql/ksHGRY8qG8MQqrKq8pY89VlNnsjVn\nbxd9DZcG8L1pfY7DpSRkMMgT0DK+BXc2u4WnsuTWZeDiP/7lXwgT8U5DE0UCAwEA\nAQKCAgAwJOITzSym7JqLHCvPfYCEsbPn1OdRBItUMtTwehyMu9Vb5u4caajERM19\nNEjGSvMnGGCSpVrxK5KVwSN5Nmh1zzR/q3Xi3+4nTfeiRkWl2v62MILf8bzji6qy\n737sTHQHg65KY7PeIxsBupTWFVv9wGEEXs/oqj9ML58P7EoI7lgghiLBme3d4nte\nZWZZkqAYWtNP0h02/RGfbvVD+ySR6AosD+njMzPGYnkNQvreNTIo2/8TJe4D4Irp\nXrCYr058L7iePjw/NVMQg4Od7fh0PyRBIvXyvfmmdOIpuD8ca3zc1+647WXnnuCa\ng1zEhEIc3XmIsrvqy0KghDEqb/WILpREhJs+zwo4OqGcujGpjZHq89a+9uuYCGiS\nP3e036CLxTiNFg77eNeZ9aXpLgCESSYZcMoBBdYbs8SOg8hxbHlVQ+QT4frozoRZ\nMNuEPMLwgNWjt7mDnxyVzmE4xPaxQsauPcfTNyXOqQEUFojq+4c3F1B3VRQn6KU7\nx7+MfoOFKG18YkblmeO7DA5YuuEJmhOqts8SpxL/4sZz3GXur0y8Uy+MW/BD85vG\ndsUGx6dfvdR8XXThfGLi+lS4yLb/cQnajVOx0artWqcjmI1nv04x7Rg9Iv+GRO7f\nlkxGMc5e3pZmlfF9HJi/gKCJKhOlhtZRLzYoT7m+SZB6FxzLgQKCAQEA9ztIRfEa\n4mQV+oGz4t/hkhHEAN2ogygout//T5yYwR3z5guvfTeUyxLIK4OWXbXd9gyrNJs4\nkf2Q1HCquFI6aEW47L7BF+EuHVq7l6mpt7orb/3TlWlFBAo+Jtiy1tdzmOi/Fdjm\nAptAQj+3oOIqNTSivkPqFRlx2wl4+F+nyHdvZ3atxvplD/ne3nrIP7xfZbot6x3t\nvl1ACVq94Lnj2CrRMQ1cI6QwPzkyXHRNc9gosE563pWSglDnSUZ2w2rjCu12baHa\n4SYQz5OeL8kYaGDH0kgjkU6jYc4nrVJxSOvIATlUUi+AJ6seYv4aDJ0l/tHmaTJ4\nU6uB1iqsjMK5TQKCAQEA0bMlEMTcWoApi2LxZQG6vTq2nJofUm6JGiV5+cPLWRgE\nnWfNMM7VX/yu8cS5ceTW7016tZEpwT6fGkNftjPVuX9jhMYv8Gj9uMbe7MEb7MIk\nTWkg3Y50gmtLxgjqqE35Pfn98vIR6pp+ZwDfOcQ5LHICXt3ubI5jiO8ERFVgKK4A\nm9k8+OLdQQKZD9UGcwmZrURxv7KpImmUx4+aFU3Bdr5Oegmci+W/zNWmzN+Lqb4V\nCGODKGOUdQs+GoOMfckhVN+L+LFO2SWedYp2Y1C+yy8ehN6VrMBN3255c0WSxz89\nFJ8LUSZypW6WeikXFAIUDfsqIYgW9+TITkJU/yuF2QKCAQAy01QjVNLDEfJWwo1Z\nqc70uYRC7U60T/A3os8Y7ceVg/PdKi/UnTWQnfbawz2JXFcaOzaDJRn3IVrB4bun\nEviA8Tx4JysJHrjdPgbswetrIvHFHzh9MdwHXZezYr85XaedGtQVyLZYeNQ4CmNU\nxsoIkB6Y4NthpQ58CjF9ViTnGG6lpYdKLbXTF/pSYImEWNR/1EuWV1vF0+PTSH1a\nkryddwf0fpuflCR7CuYojZxSoXCT9j5aPgOVmM5DiSHnQLUWTQUYurqFqM6x7dYK\nWtwSsTrDJyNwvurls30Cq70wUZCXd9K25p8BCLPBhB2U1EW4YixtGfwUr2CMx88b\nTPjNAoIBAQC4U3cmSVTEPFnISv2TYrTJtv1jpFoZ9E2RbRXNxRxOwTz1O5Py7ixD\nBnKk096KTbPcf8d4KBSC58+kn0pXdzLLrj1FLYxgD3nO3QiBJbGtKG4OmXUpKxog\ntb3SYm4Z6QhIQSHHVp8HECxB0FNnjKMQ/Vo2F3CHfZXifO7MPhubRnAEjiz5PTls\n9qKidwcHQY4S7tHpxlrDg/kifYjcZw/Cl7+VqDMyCY7Rt4+6EFnMp+gHCqn0a6vI\nQkyhs7Zfrtccqq93uCtt1pJ2EXLFE+nR4iY6dwkr45HP72TUPXiqqVzAbpjdCSXH\nYvDkio/dp4IHVBqRhPVji3fCyq256oDpAoIBAQC8Qv1qfqM/fFDvten5UC4EsI0M\nZi+VWVUHkKJNHhzXZkHRjypKNCG+R23nuaUX27zLPL/zehm5QKt7fjtrKW94C1iN\nUP2p1bbKG6XaLo8vwT1qrp9+TnxVkHvsS50+vPuSyYu5h0bx5Li9K+aEzzYhAKUi\nVjY/mqK2YQEPMUuamHj05nN12MFxVLNr2TbwoQHC2vfQ5foWO5ePfIHgb+jG1Aim\nWBu0bV+HqeE2VJ6C3sDUsl7gfYo9l8b5SqH4x5wsKwZXWosJGM92jl8E18wJrjQw\nrqIEsUIqu/ptPsbBlxjSABbhMmsJ+P+quIhiXpneNFLKmT5J74P9bGhOsaug\n-----END RSA PRIVATE KEY-----\n"
          }
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('virtualMachineName'))]"
      ]
    },
    {
      "name": "lab-vm.hosts-config",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.custom-script-linux-arm.2.0.50/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('virtualMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "fileUris": {
            "value": []
          },
          "commandToExecute": {
            "value": "bash -c \"echo 10.0.0.5 registry.ca-labs.com >> /etc/hosts && echo 10.0.0.6 production.ca-labs.com >> /etc/hosts && wget -O /tmp/server-cert.pem https://raw.githubusercontent.com/cloudacademy/docker-software-delivery/master/.certs/server-cert.pem &&  mkdir -p /etc/docker/certs.d/registry.ca-labs.com:5000/ && cp /tmp/server-cert.pem /etc/docker/certs.d/registry.ca-labs.com:5000/ca.crt\""
          }
        }
      },
      "dependsOn": [
        "microsoft.docker-lab-vm"
      ]
    },
    {
      "name": "microsoft.docker-registry",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.docker-arm.1.1.0/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('registryMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "dockerPort": {
            "value": "2376"
          },
          "dockerCACert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFmTCCA4GgAwIBAgIJAPJaED7AhAQSMA0GCSqGSIb3DQEBCwUAMGIxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEWMBQGA1UEAwwNKi5jYS1sYWJzLmNvbTAgFw0x\nNzA3MDYwMzA0MDlaGA8yMTE3MDYxMjAzMDQwOVowYjELMAkGA1UEBhMCVVMxCzAJ\nBgNVBAgMAkNBMRYwFAYDVQQHDA1TYW4gRnJhbmNpc2NvMRYwFAYDVQQKDA1DbG91\nZCBBY2FkZW15MRYwFAYDVQQDDA0qLmNhLWxhYnMuY29tMIICIjANBgkqhkiG9w0B\nAQEFAAOCAg8AMIICCgKCAgEAxXzi366wOLhpsf3iNqNwW6fxC+fF1qxmDZNiEkRN\nyAVhErL7yi5ueygFq1yCa5SDBzM6wypE8qURyCeGh6KlLWqBUEQPA5xiDbdrgS24\nf2XGrcZyFg7J6x6RoJv/0MCbfSmcS6g9XjUoMEHxbcu5xwAgKlhflPFEg1Aiw308\n5tEc2aDi18HpZ1c6fz1SuFIYsovJxcRSE6vH8k3WvwL+DOAJSfTW4PDmATCaXpwW\nGHblB0W34CGA/nAw6JP/5iOW1F+0M5kXTUKDJqQgxBGip6rqTHK74f6TsD1Ne1uY\nJhXDOeZCDQN5OBnUTcA9heABa1WxBq1SzXj13D8GT+hy8jq/2tsbQ0FQvDigjIMV\nLqQKVzCtzxVTnFZ/+uqz6WnHiNAZJYXBE+qE6QP5qGffsIkxl+QOO2E8+TdoyOTB\n2X1hh6gpw8xSdLU8l7I3utDwlRvs5Vdv534b6br+pdFZU8zhk0q6mxCBPxCDG6FY\nT5KhRw5gpUdZ9SA56lW/12jI39MqL8+vW4D3+3W195ashWH1cYfIju8b8eV8fH/D\nsVtHCntHj084A1FatdywuUGeY15YdliD4uNPmvbHJHgOB2cc5nvTP1jzBJFP8bJK\n1y3xQ+WDcnWf7NiNDEaZFKyVcJ5abkAjwMyqwzahVIdeNbfYyi4tSZRgUDenCK6T\nmNMCAwEAAaNQME4wHQYDVR0OBBYEFKozb/pQ956bvSlDb1Xt4yUbIF2rMB8GA1Ud\nIwQYMBaAFKozb/pQ956bvSlDb1Xt4yUbIF2rMAwGA1UdEwQFMAMBAf8wDQYJKoZI\nhvcNAQELBQADggIBAGW/SFFTdk4ee5jfTziJAiukTyW4s5ClnUGLyESx1TuExscl\nlwoiOztqe4Vzt6P0y2G4czpBAVfEN4jpisnpND0Vdhdiy20ZrzaEWjGaGWriYYXg\n2aBD+Y0bqIH6IENjfrmUJzvIQIYaxUgVUODSNNwHoipEaGx789wmwJEAatme0klU\n8f/6CoDbzdXYF1OtCutb1rVAkZh3aZRTSX1/mQjf9v4LZBTs0nMsusDoUHaWbNBD\nAvg4RhrEgU6Oe0YKE7UowaHZ/vEV/OpfmeXxLQEwFmYH+TPvVZLmdZupdZGYgF7d\nSQEhFylQgaZfSDILcMAIQw1QChCLC9wDXniuOpXmvDFcq2NJOP4NWCjMENqdxmvs\nm8xs3jSwo6SXyttz0XgWMoY19cGHX/Yrp4czZeTxCvCVQBhEhSH2LlstM7Vk6MBu\nOu9W7Abc2jOTXboPj49QeSWuZvVu86JUrlDCuSv4w8C7ftsUMaQVtTNZESsbItjR\n3PScuSMPDUfguqAVAPMeJc0coSd0NujIz0grlvmLJmz2r021vWLCzFM/am+4eEOG\nXxdi5KSAKl34mCsbWEpICFJ9oDqEmVJs8z/aL502VEDrL5Wvpn3CbBgY3jCmFdJG\nTgXGq7Ty+YVsckCnXDAkmuTZ7vxXSiyozHROeUavNrybvBECYuRziYEBIKZY\n-----END CERTIFICATE-----\n"
          },
          "dockerServerCert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFMzCCAxugAwIBAgIJAMbG41YxwLTlMA0GCSqGSIb3DQEBCwUAMGIxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEWMBQGA1UEAwwNKi5jYS1sYWJzLmNvbTAgFw0x\nNzA3MDYwMzA3MDBaGA8yMTE3MDYxMjAzMDcwMFowGDEWMBQGA1UEAwwNKi5jYS1s\nYWJzLmNvbTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBANU6xeJ/edar\nGYeHhwXD5d4Hke4xFVKaoeyY65dvtH3kFo1/kUWFx5wvnyMC9MRPpT2EXHV0AtX6\n0SDSVDE0UASq25kWbfJjNNEeWYvxo5kYMunKztfiUbboLtxlzHPlkioxJSRAn3yz\nnwCXNt/n7U1uvdfAHI9CBgfiUjpIJVcnoJp/Z/UfYIWwJPA+XdCdEejHI5yQHqw+\nC/QlqxJ85IIUva0UTHd0kTAHykb39pvd69rBdogeYxgWbmuTCUgzE5/Y90XkNKX0\noNRv2wTNWc/gqUvEPlhfHGPj3erCEGFW3P/hM6jVlqAm10mh7dhrE2zTJ/uBCAuC\n6uyVY6P6SsveQjYpmuy7gch3KyCARPn7tle+TpCo3LIaOZcybJlXdO5zvONkSl1j\nLzwTQu/ZYVLlPTM2iJlpZWIQiqqnuQoi9omrYaWnlxnSQejbRIRdecvfWaDvZlSK\n0+eyyjqwGpXHRGYr1sEC827ymuFjbuXt8mbXSTavyAxaoZXLTpq8YitHBFqWRpJq\nPvUYWzglD29NecP8b0jYsBqqXWxfQHmrASEg27ewNHpdQsUbpkiSnQTTNANohGBz\nY6oORC8Zl86WcJHQnlEz2HwiMUPEc/6jRusQZIR7am4ZtGWRwn30jaiCuXLEPuPV\nOheGDp+9XfbOynOP0onn/ZheNA+Ng9C5AgMBAAGjNDAyMDAGA1UdEQQpMCeCDSou\nY2EtbGFicy5jb22HBAoAAASHBAoAAAWHBAoAAAaHBH8AAAEwDQYJKoZIhvcNAQEL\nBQADggIBALmYnYqu48LAJg8p6FItCKmTc0AEe8pp/XlBEm8nQqG7aE8rxDX5spNY\n1urlgHu2Xtmphs9Jz0hb2NE9jUL8t2K33ZrKOc4JyGhQrfJk5LI0OOWa2Tzvbny6\nrtrJfRihkIjeAi2uzhD8Y0aym0ZHiDU/kZ7ylkYi/lPVkigomeanoo0FjsyBM+Q9\nz+eGy6Yy3xLlq/YPwct+KRc5p+HpiKeSTajWRStGH8G8JKcc1dE6u7GeE337RXks\ncYxcAfyGWSpdEb6KRqqPsD7BTVmslfjf/hc0OJ8uEg0YC5F8Xf95qflWTs6qMX8R\nHeQ/F/IbvH2M9kWQs+qWwThEvgnbSxKgA/tPONv0Hp0C6cle9A6ItyKRRUFNgC+4\nosg27E2EpPO/OvIKWSAoKGDNenJHLW1bmnhzrGNBCSxrBFm6vMZ6nwUCQUJNLDht\nNdQBAOfr4ScHGTRHF7FO81QZV4/rKCInfoiqJUrFYeuAfeusQVnbEdx5xgoJINvo\nlR7CXOTZ8Ga4k2TlIGBnzHDLUlycm0U3VHdHvk2Sa8tHHVXEZSs6z0+XLQMZldAA\nim6/cv2bxQXwGqPRmNswKFpCTNZRS+Z/NqbIeLqSxdrEe7XyorERW/ngiMNIJgYV\n0o3gdLYBbMfZRGTh85ClbrJd8oMRLL0/DoFy6YB6qkxlh4uLd5vf\n-----END CERTIFICATE-----\n"
          },
          "dockerServerKey": {
            "value": "-----BEGIN RSA PRIVATE KEY-----\n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\n-----END RSA PRIVATE KEY-----\n"
          }
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('registryMachineName'))]"
      ]
    },
    {
      "name": "registry.hosts-config",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.custom-script-linux-arm.2.0.50/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('registryMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "fileUris": {
            "value": []
          },
          "commandToExecute": {
            "value": "bash -c \"echo 10.0.0.5 registry.ca-labs.com >> /etc/hosts && echo 10.0.0.6 production.ca-labs.com >> /etc/hosts && mkdir -p /etc/docker/certs.d/registry.ca-labs.com:5000/ && cp /etc/docker/cert.pem /etc/docker/certs.d/registry.ca-labs.com:5000/ca.crt\""
          }
        }
      },
      "dependsOn": [
        "microsoft.docker-registry"
      ]
    },
    {
      "name": "microsoft.docker-production",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.docker-arm.1.1.0/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('productionMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "dockerPort": {
            "value": "2376"
          },
          "dockerCACert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFmTCCA4GgAwIBAgIJAPJaED7AhAQSMA0GCSqGSIb3DQEBCwUAMGIxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEWMBQGA1UEAwwNKi5jYS1sYWJzLmNvbTAgFw0x\nNzA3MDYwMzA0MDlaGA8yMTE3MDYxMjAzMDQwOVowYjELMAkGA1UEBhMCVVMxCzAJ\nBgNVBAgMAkNBMRYwFAYDVQQHDA1TYW4gRnJhbmNpc2NvMRYwFAYDVQQKDA1DbG91\nZCBBY2FkZW15MRYwFAYDVQQDDA0qLmNhLWxhYnMuY29tMIICIjANBgkqhkiG9w0B\nAQEFAAOCAg8AMIICCgKCAgEAxXzi366wOLhpsf3iNqNwW6fxC+fF1qxmDZNiEkRN\nyAVhErL7yi5ueygFq1yCa5SDBzM6wypE8qURyCeGh6KlLWqBUEQPA5xiDbdrgS24\nf2XGrcZyFg7J6x6RoJv/0MCbfSmcS6g9XjUoMEHxbcu5xwAgKlhflPFEg1Aiw308\n5tEc2aDi18HpZ1c6fz1SuFIYsovJxcRSE6vH8k3WvwL+DOAJSfTW4PDmATCaXpwW\nGHblB0W34CGA/nAw6JP/5iOW1F+0M5kXTUKDJqQgxBGip6rqTHK74f6TsD1Ne1uY\nJhXDOeZCDQN5OBnUTcA9heABa1WxBq1SzXj13D8GT+hy8jq/2tsbQ0FQvDigjIMV\nLqQKVzCtzxVTnFZ/+uqz6WnHiNAZJYXBE+qE6QP5qGffsIkxl+QOO2E8+TdoyOTB\n2X1hh6gpw8xSdLU8l7I3utDwlRvs5Vdv534b6br+pdFZU8zhk0q6mxCBPxCDG6FY\nT5KhRw5gpUdZ9SA56lW/12jI39MqL8+vW4D3+3W195ashWH1cYfIju8b8eV8fH/D\nsVtHCntHj084A1FatdywuUGeY15YdliD4uNPmvbHJHgOB2cc5nvTP1jzBJFP8bJK\n1y3xQ+WDcnWf7NiNDEaZFKyVcJ5abkAjwMyqwzahVIdeNbfYyi4tSZRgUDenCK6T\nmNMCAwEAAaNQME4wHQYDVR0OBBYEFKozb/pQ956bvSlDb1Xt4yUbIF2rMB8GA1Ud\nIwQYMBaAFKozb/pQ956bvSlDb1Xt4yUbIF2rMAwGA1UdEwQFMAMBAf8wDQYJKoZI\nhvcNAQELBQADggIBAGW/SFFTdk4ee5jfTziJAiukTyW4s5ClnUGLyESx1TuExscl\nlwoiOztqe4Vzt6P0y2G4czpBAVfEN4jpisnpND0Vdhdiy20ZrzaEWjGaGWriYYXg\n2aBD+Y0bqIH6IENjfrmUJzvIQIYaxUgVUODSNNwHoipEaGx789wmwJEAatme0klU\n8f/6CoDbzdXYF1OtCutb1rVAkZh3aZRTSX1/mQjf9v4LZBTs0nMsusDoUHaWbNBD\nAvg4RhrEgU6Oe0YKE7UowaHZ/vEV/OpfmeXxLQEwFmYH+TPvVZLmdZupdZGYgF7d\nSQEhFylQgaZfSDILcMAIQw1QChCLC9wDXniuOpXmvDFcq2NJOP4NWCjMENqdxmvs\nm8xs3jSwo6SXyttz0XgWMoY19cGHX/Yrp4czZeTxCvCVQBhEhSH2LlstM7Vk6MBu\nOu9W7Abc2jOTXboPj49QeSWuZvVu86JUrlDCuSv4w8C7ftsUMaQVtTNZESsbItjR\n3PScuSMPDUfguqAVAPMeJc0coSd0NujIz0grlvmLJmz2r021vWLCzFM/am+4eEOG\nXxdi5KSAKl34mCsbWEpICFJ9oDqEmVJs8z/aL502VEDrL5Wvpn3CbBgY3jCmFdJG\nTgXGq7Ty+YVsckCnXDAkmuTZ7vxXSiyozHROeUavNrybvBECYuRziYEBIKZY\n-----END CERTIFICATE-----\n"
          },
          "dockerServerCert": {
            "value": "-----BEGIN CERTIFICATE-----\nMIIFMzCCAxugAwIBAgIJAMbG41YxwLTlMA0GCSqGSIb3DQEBCwUAMGIxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEWMBQG\nA1UECgwNQ2xvdWQgQWNhZGVteTEWMBQGA1UEAwwNKi5jYS1sYWJzLmNvbTAgFw0x\nNzA3MDYwMzA3MDBaGA8yMTE3MDYxMjAzMDcwMFowGDEWMBQGA1UEAwwNKi5jYS1s\nYWJzLmNvbTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBANU6xeJ/edar\nGYeHhwXD5d4Hke4xFVKaoeyY65dvtH3kFo1/kUWFx5wvnyMC9MRPpT2EXHV0AtX6\n0SDSVDE0UASq25kWbfJjNNEeWYvxo5kYMunKztfiUbboLtxlzHPlkioxJSRAn3yz\nnwCXNt/n7U1uvdfAHI9CBgfiUjpIJVcnoJp/Z/UfYIWwJPA+XdCdEejHI5yQHqw+\nC/QlqxJ85IIUva0UTHd0kTAHykb39pvd69rBdogeYxgWbmuTCUgzE5/Y90XkNKX0\noNRv2wTNWc/gqUvEPlhfHGPj3erCEGFW3P/hM6jVlqAm10mh7dhrE2zTJ/uBCAuC\n6uyVY6P6SsveQjYpmuy7gch3KyCARPn7tle+TpCo3LIaOZcybJlXdO5zvONkSl1j\nLzwTQu/ZYVLlPTM2iJlpZWIQiqqnuQoi9omrYaWnlxnSQejbRIRdecvfWaDvZlSK\n0+eyyjqwGpXHRGYr1sEC827ymuFjbuXt8mbXSTavyAxaoZXLTpq8YitHBFqWRpJq\nPvUYWzglD29NecP8b0jYsBqqXWxfQHmrASEg27ewNHpdQsUbpkiSnQTTNANohGBz\nY6oORC8Zl86WcJHQnlEz2HwiMUPEc/6jRusQZIR7am4ZtGWRwn30jaiCuXLEPuPV\nOheGDp+9XfbOynOP0onn/ZheNA+Ng9C5AgMBAAGjNDAyMDAGA1UdEQQpMCeCDSou\nY2EtbGFicy5jb22HBAoAAASHBAoAAAWHBAoAAAaHBH8AAAEwDQYJKoZIhvcNAQEL\nBQADggIBALmYnYqu48LAJg8p6FItCKmTc0AEe8pp/XlBEm8nQqG7aE8rxDX5spNY\n1urlgHu2Xtmphs9Jz0hb2NE9jUL8t2K33ZrKOc4JyGhQrfJk5LI0OOWa2Tzvbny6\nrtrJfRihkIjeAi2uzhD8Y0aym0ZHiDU/kZ7ylkYi/lPVkigomeanoo0FjsyBM+Q9\nz+eGy6Yy3xLlq/YPwct+KRc5p+HpiKeSTajWRStGH8G8JKcc1dE6u7GeE337RXks\ncYxcAfyGWSpdEb6KRqqPsD7BTVmslfjf/hc0OJ8uEg0YC5F8Xf95qflWTs6qMX8R\nHeQ/F/IbvH2M9kWQs+qWwThEvgnbSxKgA/tPONv0Hp0C6cle9A6ItyKRRUFNgC+4\nosg27E2EpPO/OvIKWSAoKGDNenJHLW1bmnhzrGNBCSxrBFm6vMZ6nwUCQUJNLDht\nNdQBAOfr4ScHGTRHF7FO81QZV4/rKCInfoiqJUrFYeuAfeusQVnbEdx5xgoJINvo\nlR7CXOTZ8Ga4k2TlIGBnzHDLUlycm0U3VHdHvk2Sa8tHHVXEZSs6z0+XLQMZldAA\nim6/cv2bxQXwGqPRmNswKFpCTNZRS+Z/NqbIeLqSxdrEe7XyorERW/ngiMNIJgYV\n0o3gdLYBbMfZRGTh85ClbrJd8oMRLL0/DoFy6YB6qkxlh4uLd5vf\n-----END CERTIFICATE-----\n"
          },
          "dockerServerKey": {
            "value": "-----BEGIN RSA PRIVATE KEY-----\nMIIJKAIBAAKCAgEA1TrF4n951qsZh4eHBcPl3geR7jEVUpqh7Jjrl2+0feQWjX+R\nRYXHnC+fIwL0xE+lPYRcdXQC1frRINJUMTRQBKrbmRZt8mM00R5Zi/GjmRgy6crO\n1+JRtugu3GXMc+WSKjElJECffLOfAJc23+ftTW6918Acj0IGB+JSOkglVyegmn9n\n9R9ghbAk8D5d0J0R6McjnJAerD4L9CWrEnzkghS9rRRMd3SRMAfKRvf2m93r2sF2\niB5jGBZua5MJSDMTn9j3ReQ0pfSg1G/bBM1Zz+CpS8Q+WF8cY+Pd6sIQYVbc/+Ez\nqNWWoCbXSaHt2GsTbNMn+4EIC4Lq7JVjo/pKy95CNima7LuByHcrIIBE+fu2V75O\nkKjcsho5lzJsmVd07nO842RKXWMvPBNC79lhUuU9MzaImWllYhCKqqe5CiL2iath\npaeXGdJB6NtEhF15y99ZoO9mVIrT57LKOrAalcdEZivWwQLzbvKa4WNu5e3yZtdJ\nNq/IDFqhlctOmrxiK0cEWpZGkmo+9RhbOCUPb015w/xvSNiwGqpdbF9AeasBISDb\nt7A0el1CxRumSJKdBNM0A2iEYHNjqg5ELxmXzpZwkdCeUTPYfCIxQ8Rz/qNG6xBk\nhHtqbhm0ZZHCffSNqIK5csQ+49U6F4YOn71d9s7Kc4/Sief9mF40D42D0LkCAwEA\nAQKCAgAhW+GLjt/z2q7SyjwwhbZXpx2IgztPwgtlJYNuHLbDH0T7/CIxGz3gTH78\nDkFW2RMD7co9QdoTufqvxNgRHpsKL+TNLXoj+qtPsAzYXQR4NhX5B5aWpbyc/fQe\n3PpAg4D7gtbJtiZ9buiIQh/+pZ01iQbAUzjknLKu1xSAM7tLyFJS+W29JpyGLcmJ\noGgy8+/SWB1VKCL0VXyvRJlf+hQR2cbW5h8UbTMtrXpS4gY92llEzxGJOB/Oq+u4\nfrdsCTmfv2ToFUy7Tes/cQR12t6bLA2wYdJTJwYdBpA4YwYHBHzst0HKvyeihJEX\n3vKD8jSGyP4vVb95dZDlVHXTOJwswaiU9zdHjZxsnh/mToKGOheatnTY+3XTOUoo\nPbquSVbfsQCuvfodBKzcAOwhVOH+ZO6bDvaPEbwQdMXQUJ0L+8rvL1YuXz9mycwJ\ng4dXWPOoEFvClH0SHdGEebztbY9R5Sn32Wjloo6qC1ldDnpBkCKTE+5g5a3bCZLI\nnuedDCa9qSB45RCo+pxKv5gKaoWz61SwzDP3SngWbqizXlBuqSSZRdiyLD+psjOb\nB2cfZ8OjZKxuWfqMuzFWgSyiCnG5Li41dtdUxOQz5fA8mYJ6tws8U0lZGAqVg5ny\nQPZvauPTI0fZd4wJdmWWLSiLzkEQZR1gIMT+cKqafoqSgoao1QKCAQEA+LIufbqZ\ndSm1qfniGWaXyoiWcInFZzcI6kPHGHKuORjjMFp1PTcaTxRLA/+AWQLkYj2UJYZV\nmpHN+gAeoKLsqQ9KSnCQm0+we3eg4rJyBli+DD5wXYs4rFO6E41GeySsevSw3tYu\n2C1q+6KzP44H44yIvdxxcFDkOikb8dYv/ITigCQtaoyBG93aaGX3u6gd9CsoFWXk\nfEq78DSH9EMzcic4AXQl+VsOKMtHNcOt/j4FeF6CktI+/TJNZtAepOMKDNZXfQsi\nvffrtqzIcCXtn6lQRJebN5Kg5Oy168GS6JEUmKKSpoeV59I20g9SuUjkXkG4m6ms\nmRuk/d8xPO6ggwKCAQEA233v9OChdAleHgB4SwiC/CzccVwKflMsavnLaQcgU1aZ\norRB/gGI3saoG5HHnT/DgXNTH6ZbEjAIBRtJOhAIbpHbRiQ/4gNlnSFWfQfzOPeh\nljAdXOgm9TS924bH82zS8Hs6RcSLyfBfJgyrSQX+g72NCiIFCl0yYMsdv8wP3ufA\nLbeApsG7VWN+A5tqWCwoJns5YVZbYu2f4DVGni3pxmo99C9qPaHenPOafIpFUM5G\n+yjr9qgM/n44z9LdEbZzMXRif8yEuGseVhdhvj5UsKwTusFXY/XTGBR3nzHr4zt4\n5WVIP7w5EWiplFgp9ybofQYj14r8E9tBUt83bJfNEwKCAQBuxbbNi7rko+Jlxoa9\n96Nus+4GTGdf9PSEnBHnQtV1Wy9+jxwfWxbd2FUdf8WkYBRn6bO+Dxq8EWukij8a\nH9e36baWd5MBiro6FGvV7dO6HfbwrzMPh36Dy3tbUBbvrMMitTC+4LnW0kwPr0WV\n7mZ3JVaW8sSYWX9+pGbtDhErsejNWM/d4J11UxkAXUK+FEDbTAm7ljnyXrtdX5ia\n5P/aPbvFcf2kFrm00+5w9SrfzrJTDg2s5fbmgmxVeifcG8CTPTmU2cvsv6v/HvDc\nexhfgGPfWYPqeeYucX0KeJs9+bkpz2fwwv2zVz/Ryr93Bg+qKC3ZL/dP7y9LYQmm\ncUePAoIBAQC7C6p2SwsroGQFOy9H+fvtvKkrLV1/449BppeSbFE+09jfT6/BLzud\nZTuTKvsp5VHNOiMHILQRXr8m4ubXRRx6ZW+waWnLSEvKyMM0j5bU4Cpim6QaLXgt\nlAGLV2OD7SQhbVHubJ0XvPDIsxkwhJwtVlYf4XfcKimpVM6ISPTpZyNdkjhfY08q\naDvWBRZuB0s759yxN29vccLBxYTlfYjv3k/njJSD6zKTHAF1yjthrjfNB0V2kCVq\nptPxPufHlWy7I0xhTj94DUjv4sMX5XQ0jp/Nkb/QXofCyIZcMqWrol3XVyVnsxYK\n4N9KnIs+pHiROq9GmplQrpMPdUt9DivjAoIBACr1d47rkZu9R2nTmGJmrA2sF/N+\nvROGc5GhenSZyHZsoG1ZSFCGgbhMF+0qBEm6GSv/KT2UYMkk1ud9KBj//djt1NDm\ntTu2vqcYb7+Hm3hjSFCRbJJ0h0kmyo83uUHcjRKsVybDMjMBh0wHPexpXf+8TN0m\nWvFMHc8rvhrQnVvQs+bikAb36ybO0/aDZc0f+Wbs7JMSyiIsnsQsJfjlNd2UTKi5\n4RgflF8RowebgjQXWQyr1GNKuoy9x/hbpwBja5iMrcJULIPe84Zv9RW0RtYEEFIs\nJ2sp5mbWhda6Wr+xZFJmtaspxIESc9d+DyGmxmfhd2mkECUsDn5M18F//Wk=\n-----END RSA PRIVATE KEY-----\n"
          }
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Compute/virtualMachines/', parameters('productionMachineName'))]"
      ]
    },
    {
      "name": "production.hosts-config",
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "incremental",
        "templateLink": {
          "uri": "https://gallery.azure.com/artifact/20161101/microsoft.custom-script-linux-arm.2.0.50/Artifacts/MainTemplate.json"
        },
        "parameters": {
          "vmName": {
            "value": "[parameters('productionMachineName')]"
          },
          "location": {
            "value": "[resourceGroup().location]"
          },
          "fileUris": {
            "value": []
          },
          "commandToExecute": {
            "value": "bash -c \"echo 10.0.0.5 registry.ca-labs.com >> /etc/hosts && echo 10.0.0.6 production.ca-labs.com >> /etc/hosts && mkdir -p /etc/docker/certs.d/registry.ca-labs.com:5000/ && cp /etc/docker/cert.pem /etc/docker/certs.d/registry.ca-labs.com:5000/ca.crt\""
          }
        }
      },
      "dependsOn": [
        "microsoft.docker-production"
      ]
    },
    {
      "name": "[replace(concat(parameters('storageAccountName'), resourceGroup().name),'-', '')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "properties": {
        "accountType": "[parameters('storageAccountType')]"
      }
    },
    {
      "name": "[parameters('virtualNetworkName')]",
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2016-12-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('addressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[parameters('subnetName')]",
            "properties": {
              "addressPrefix": "[parameters('subnetPrefix')]"
            }
          }
        ]
      }
    },
    {
      "name": "[parameters('networkInterfaceName')]",
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]",
        "[concat('Microsoft.Network/publicIpAddresses/', parameters('publicIpAddressName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName')), '/subnets/', parameters('subnetName'))]"
              },
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "10.0.0.4",
              "publicIpAddress": {
                "id": "[resourceId('Microsoft.Network/publicIpAddresses', parameters('publicIpAddressName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
        }
      }
    },
    {
      "name": "[parameters('publicIpAddressName')]",
      "type": "Microsoft.Network/publicIpAddresses",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIpAllocationMethod": "[parameters('publicIpAddressType')]"
      }
    },
    {
      "name": "[parameters('registryInterfaceName')]",
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]",
        "[concat('Microsoft.Network/publicIpAddresses/', parameters('registryPublicIpAddressName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName')), '/subnets/', parameters('subnetName'))]"
              },
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "10.0.0.5",
              "publicIpAddress": {
                "id": "[resourceId('Microsoft.Network/publicIpAddresses', parameters('registryPublicIpAddressName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
        }
      }
    },
    {
      "name": "[parameters('registryPublicIpAddressName')]",
      "type": "Microsoft.Network/publicIpAddresses",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIpAllocationMethod": "[parameters('publicIpAddressType')]"
      }
    },
    {
      "name": "[parameters('productionInterfaceName')]",
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]",
        "[concat('Microsoft.Network/publicIpAddresses/', parameters('productionPublicIpAddressName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName')), '/subnets/', parameters('subnetName'))]"
              },
              "privateIPAllocationMethod": "Static",
              "privateIPAddress": "10.0.0.6",
              "publicIpAddress": {
                "id": "[resourceId('Microsoft.Network/publicIpAddresses', parameters('productionPublicIpAddressName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
        }
      }
    },
    {
      "name": "[parameters('productionPublicIpAddressName')]",
      "type": "Microsoft.Network/publicIpAddresses",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIpAllocationMethod": "[parameters('publicIpAddressType')]"
      }
    },
    {
      "name": "[parameters('networkSecurityGroupName')]",
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2016-09-01",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
            "name": "allow-docker-remote",
            "properties": {
              "priority": 1400,
              "sourceAddressPrefix": "*",
              "protocol": "TCP",
              "destinationPortRange": "2376",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "allow-registry",
            "properties": {
              "priority": 1300,
              "sourceAddressPrefix": "*",
              "protocol": "TCP",
              "destinationPortRange": "5000",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "allow-http-dev",
            "properties": {
              "priority": 1200,
              "sourceAddressPrefix": "*",
              "protocol": "TCP",
              "destinationPortRange": "3000",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "allow-http",
            "properties": {
              "priority": 1100,
              "sourceAddressPrefix": "*",
              "protocol": "TCP",
              "destinationPortRange": "80",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "default-allow-ssh",
            "properties": {
              "priority": 1000,
              "sourceAddressPrefix": "*",
              "protocol": "TCP",
              "destinationPortRange": "22",
              "access": "Allow",
              "direction": "Inbound",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    }
  ],
  "outputs": {
    "adminUsername": {
      "type": "string",
      "value": "[parameters('adminUsername')]"
    }
  }
}